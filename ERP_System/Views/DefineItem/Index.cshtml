@using ERP_System.ViewModels
@model AddItemVm

@{
    ViewData["Title"] = "إضافة صنف";
}

<div class="container-fluid fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary">
                <i class="bi bi-box-seam me-2"></i> إضافة صنف جديد
            </h2>
            <p class="text-muted">إدخال بيانات صنف جديد إلى النظام</p>
        </div>
        <a href="@Url.Action("Index", "Dashboard")" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-right me-2"></i> عودة
        </a>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
            <form asp-action="Index" method="post" enctype="multipart/form-data">
                <div class="row g-4">
                    <!-- Basic Info -->
                    <div class="col-md-12">
                        <h5 class="fw-bold mb-3 text-secondary border-bottom pb-2">البيانات الأساسية</h5>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Name" class="form-label fw-bold">اسم الصنف <span
                                class="text-danger">*</span></label>
                        <input asp-for="Name" class="form-control" placeholder="أدخل اسم الصنف" maxlength="250"
                            required>
                        <span asp-validation-for="Name" class="text-danger small"></span>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">الشركة المصنعة</label>
                        <select asp-for="CompanyMade" class="form-select">
                            <option value="">اختر الشركة...</option>
                            @if (ViewBag.companies != null)
                            {
                                foreach (var c in ViewBag.companies)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Pricing & Stock -->
                    <div class="col-md-12 mt-4">
                        <h5 class="fw-bold mb-3 text-secondary border-bottom pb-2">التسعير والمخزون</h5>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="BuyPrice" class="form-label fw-bold">سعر الشراء</label>
                        <div class="input-group">
                            <input asp-for="BuyPrice" type="number" step="0.01" class="form-control" placeholder="0.00">
                            <span class="input-group-text">ج.م</span>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="SalePrice" class="form-label fw-bold">سعر البيع</label>
                        <div class="input-group">
                            <input asp-for="SalePrice" type="number" step="0.01" class="form-control"
                                placeholder="0.00">
                            <span class="input-group-text">ج.م</span>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="MinimumQuantity" class="form-label fw-bold">الحد الأدنى للكمية</label>
                        <input asp-for="MinimumQuantity" type="number" class="form-control">
                    </div>

                    <div class="col-md-3">
                        <label asp-for="MinQuantitySale" class="form-label fw-bold">الحد الأدنى للبيع</label>
                        <input asp-for="MinQuantitySale" type="number" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label asp-for="DefaultStore" class="form-label fw-bold">المخزن الافتراضي</label>
                        <select asp-for="DefaultStore" class="form-select">
                            <option value="">اختر المخزن...</option>
                            @if (ViewBag.stores != null)
                            {
                                foreach (var c in ViewBag.stores)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="UnitNumber" class="form-label fw-bold">الوحدة</label>
                        <select asp-for="UnitNumber" class="form-select">
                            <option value="">اختر الوحدة...</option>
                            @if (ViewBag.units != null)
                            {
                                foreach (var c in ViewBag.units)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Dynamic Fields -->
                    <div class="col-md-12 mt-4">
                        <h5 class="fw-bold mb-3 text-secondary border-bottom pb-2">تفاصيل إضافية</h5>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">أكواد الصنف</label>
                        <div id="codesContainer">
                            <div class="input-group mb-2">
                                <input type="text" name="Codes[0]" class="form-control" placeholder="أدخل كود الصنف"
                                    maxlength="200" />
                                <button type="button" class="btn btn-success add-code"><i
                                        class="bi bi-plus"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold">التصنيفات</label>
                        <div id="categoriesContainer">
                            <div class="input-group mb-2">
                                <select name="CategoryIds[0]" class="form-select">
                                    <option value="">اختر التصنيف...</option>
                                    @if (ViewBag.categories != null)
                                    {
                                        foreach (var c in ViewBag.categories)
                                        {
                                            <option value="@c.Id">@c.Name</option>
                                        }
                                    }
                                </select>
                                <button type="button" class="btn btn-success add-category"><i
                                        class="bi bi-plus"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Settings & Image -->
                    <div class="col-md-12 mt-4">
                        <h5 class="fw-bold mb-3 text-secondary border-bottom pb-2">الإعدادات والصورة</h5>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-light border-0 p-3">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" asp-for="IsActiveBuy" checked>
                                <label class="form-check-label" asp-for="IsActiveBuy">تفعيل الشراء</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" asp-for="IsActiveSale" checked>
                                <label class="form-check-label" asp-for="IsActiveSale">تفعيل البيع</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" asp-for="PreventFraction" checked>
                                <label class="form-check-label" asp-for="PreventFraction">منع الكسور</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" asp-for="PreventDiscount" checked>
                                <label class="form-check-label" asp-for="PreventDiscount">منع الخصم</label>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Image" class="form-label fw-bold">صورة الصنف</label>
                        <input type="file" asp-for="Image" class="form-control" accept="image/*">
                        <div class="form-text">يفضل استخدام صور بخلفية شفافة (PNG)</div>
                    </div>

                    <div class="col-12 mt-4 text-end">
                        <button type="submit" class="btn btn-primary px-5 btn-lg">
                            <i class="bi bi-save me-2"></i> حفظ الصنف
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let codeIndex = 1;
        let categoryIndex = 1;

        document.addEventListener("click", function (e) {
            // Add Code
            if (e.target.closest(".add-code")) {
                let container = document.getElementById("codesContainer");
                let row = document.createElement("div");
                row.className = "input-group mb-2 fade-in";
                row.innerHTML = `
                        <input type="text" name="Codes[${codeIndex}]" class="form-control" placeholder="أدخل كود الصنف" maxlength="200" />
                        <button type="button" class="btn btn-outline-danger remove-btn"><i class="bi bi-trash"></i></button>
                    `;
                container.appendChild(row);
                codeIndex++;
            }

            // Add Category
            if (e.target.closest(".add-category")) {
                let container = document.getElementById("categoriesContainer");
                // Clone options from the first select
                let firstSelect = container.querySelector("select");
                let options = firstSelect ? firstSelect.innerHTML : "";

                let row = document.createElement("div");
                row.className = "input-group mb-2 fade-in";
                row.innerHTML = `
                        <select name="CategoryIds[${categoryIndex}]" class="form-select">
                            ${options}
                        </select>
                        <button type="button" class="btn btn-outline-danger remove-btn"><i class="bi bi-trash"></i></button>
                    `;
                container.appendChild(row);
                categoryIndex++;
            }

            // Remove Row
            if (e.target.closest(".remove-btn")) {
                e.target.closest(".input-group").remove();
            }
        });
    </script>
}
